#!/usr/bin/env ruby
require 'optparse'
require 'logger'
begin
  require 'dtr'
rescue LoadError
  require 'rubygems'
  require 'dtr'
end

NOTES = <<-NOTES
----------------
Notes: 
  * The default value of server address is 'localhost'. If DTR Server start with 'localhost', it would not be found by remote machine. If you run the runner agent on remote machine, you should start the server and runner agent with same server address specified, e.g. dtr -s -a 10.18.1.1, dtr -r r1,r2 -a 10.18.1.1
  * Runners specified by -r option will be started in different processes by the runner agent.
  * You need install gem daemons to use -D option.
  * When specify -D option, dtr_runners.pid/dtr_server.pid will be created in the directory to store the daemon process pid. And the output of the process will be print into *.output file.

DTR is a distributed test runner program for decreasing time of running ruby tests based on ruby 'test/unit' package.
For additional information, see http://dtr.rubyforge.org/
NOTES

opts = OptionParser.new do |opts|
  opts.banner = "DTR usage: #{$0} [options]"
  opts.separator ""
  opts.separator "Synopsis:"
  opts.separator "dtr -s"
  opts.separator "dtr -r runner1_name,runner2_name"
  opts.separator "dtr -a dtr_server_ip -m"
  opts.separator ""
  opts.separator "Options:"
  
  opts.on_tail("-m", "--monitor", "Monitor the status of the dtr rinda server, e.g. dtr -a 10.11.1.2 -m") do
    DTROPTIONS[:monitor] = true
  end
  
  opts.on_tail("-c", "--clean_server", "Clean server environment, shutdown all runners registered.") do
    DTR.clean_server
  end
  
  opts.on_tail("-b", "--be_silent", "Only show error messages") do
    DTROPTIONS[:log_level] = Logger::ERROR
  end

  opts.on_tail("-s", "--server", "Start DTR service server. There must be a DTR server running.") do
    DTROPTIONS[:start_server] = true
  end
  
  opts.on("-p", "--port PORT",  "Port number DTR will listen to. Default is 3344.") do |port|
    	DTR.port = port
  end
  
  opts.on("-r runner1_name,runner2_name", Array, "Start DTR test runner agent with unique runner names.") do |names|
    DTROPTIONS[:names] = names.collect{|name| name.untaint}
  end
  
  opts.on("-a", "--server_address ADDRESS", "Specify dtr server address, domain name or ip address, e.g. 192.168.0.1. Default is 'localhost'.") do |address|
    if (!address.nil?) && (!address.empty?)
      DTR.broadcast_list = [address]
    end
  end

  opts.on("-i", "--setup COMMAND", "Set command for initializing test runner test environment, e.g. 'rake db:test:prepare'. Default is do nothing.") do |command|
    DTROPTIONS[:setup] = command.untaint
  end
  
  opts.on_tail("-D", "--daemon", "Start server/runners in daemon mode. Gem 'daemons' must be installed") do
    DTROPTIONS[:daemon] = true
  end
  
  opts.on_tail("-S", "--stop_server", "Stop server run in daemon mode.") do
    DTR.stop_server_daemon_mode
  end
  
  opts.on_tail("-R", "--stop_runners", "Stop runners run in daemon mode.") do
    DTR.stop_runners_daemon_mode
  end
  
  opts.on_tail("-d", "--debug", "output debug log") do
    DTROPTIONS[:log_level] = Logger::DEBUG
  end
  
  opts.on_tail("-v", "--version", "Show version") do
    puts "dtr, version " + DTRVERSION
  end

  opts.on_tail("-h", "--help", "Show this help doc") do 
    puts opts
    puts NOTES
  end
end

no_argv = ARGV.empty?

opts.parse!

if no_argv
  puts opts
  puts NOTES
end

if DTROPTIONS[:names]
  if DTROPTIONS[:daemon]
    DTR.start_runners_daemon_mode
  else
    DTR.start_runners
  end
end

if DTROPTIONS[:start_server]
  if DTROPTIONS[:daemon]
    DTR.start_server_daemon_mode
  else
    DTR.start_server
  end
end

if DTROPTIONS[:monitor]
  if DTROPTIONS[:daemon]
    puts "Can't start monitor with daemon mode."
  else
    DTR.monitor
  end
end